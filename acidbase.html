<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Acid–Base & Osmolar Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    h1, h2 {
      margin-top: 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .inputs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px 16px;
      margin-bottom: 20px;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }
    .input-group label {
      margin-bottom: 4px;
    }
    .input-group input {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    .results {
      border-top: 1px solid #ddd;
      padding-top: 15px;
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .results-table th,
    .results-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    .results-table th {
      background-color: #fafafa;
    }
    .note {
      font-size: 0.8rem;
      color: #555;
      margin-top: 10px;
    }
    .interpretation {
      font-size: 0.85rem;
      margin-top: 6px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Acid–Base & Osmolar Calculator</h1>
  <p>Units are SI by default. Calculations update automatically when you change inputs.</p>

  <h2>Inputs</h2>
  <div class="inputs-grid">
    <!-- Electrolytes / chemistry -->
    <div class="input-group">
      <label for="na">Na⁺ (mmol/L)</label>
      <input id="na" type="number" step="0.1" oninput="calculateAll()">
    </div>
    <div class="input-group">
      <label for="k">K⁺ (mmol/L)</label>
      <input id="k" type="number" step="0.1" oninput="calculateAll()">
    </div>
    <div class="input-group">
      <label for="cl">Cl⁻ (mmol/L)</label>
      <input id="cl" type="number" step="0.1" oninput="calculateAll()">
    </div>
    <div class="input-group">
      <label for="hco3">HCO₃⁻ (mmol/L)</label>
      <input id="hco3" type="number" step="0.1" oninput="calculateAll()">
    </div>
    <div class="input-group">
      <label for="albumin">Albumin (g/L)</label>
      <input id="albumin" type="number" step="1" oninput="calculateAll()">
    </div>
    <div class="input-group">
      <label for="glucose">Glucose (mmol/L)</label>
      <input id="glucose" type="number" step="0.1" oninput="calculateAll()">
    </div>
    <div class="input-group">
      <label for="urea">Urea (mmol/L)</label>
      <input id="urea" type="number" step="0.1" oninput="calculateAll()">
    </div>
    <div class="input-group">
      <label for="osmMeasured">Measured osmolality (mOsm/kg)</label>
      <input id="osmMeasured" type="number" step="1" oninput="calculateAll()">
    </div>
    <div class="input-group">
      <label for="lactate">Lactate (mmol/L, optional)</label>
      <input id="lactate" type="number" step="0.1" oninput="calculateAll()">
    </div>
    <div class="input-group">
      <label for="pco2">Measured pCO₂ (mmHg, optional)</label>
      <input id="pco2" type="number" step="0.1" oninput="calculateAll()">
    </div>
    <div class="input-group">
      <label for="ph">pH (arterial)</label>
      <input id="ph" type="number" step="0.001" oninput="calculateAll()">
    </div>
  </div>

  <div class="results">
    <h2>Results</h2>
    <table class="results-table">
      <tr>
        <th>Calculation</th>
        <th>Value</th>
        <th>Units / Notes</th>
      </tr>
      <tr>
        <td>Anion gap (AG)</td>
        <td><span id="anionGap">--</span></td>
        <td>mmol/L (Na⁺ − (Cl⁻ + HCO₃⁻))</td>
      </tr>
      <tr>
        <td>Corrected AG for albumin</td>
        <td><span id="corrAnionGap">--</span></td>
        <td>mmol/L (AG + 0.25 × (40 − albumin[g/L]))</td>
      </tr>
      <tr>
        <td>Corrected Na⁺ for glucose</td>
        <td><span id="corrNa">--</span></td>
        <td>mmol/L (approx: +0.288 × (glucose − 5.6))</td>
      </tr>
      <tr>
        <td>Calculated osmolality</td>
        <td><span id="calcOsm">--</span></td>
        <td>mOsm/kg (2 × Na⁺ + glucose + urea)</td>
      </tr>
      <tr>
        <td>Osmolar gap</td>
        <td><span id="osmGap">--</span></td>
        <td>mOsm/kg (measured − calculated)</td>
      </tr>
      <tr>
        <td>Delta AG</td>
        <td><span id="deltaAg">--</span></td>
        <td>mmol/L (AG − 12)</td>
      </tr>
      <tr>
        <td>Delta HCO₃⁻</td>
        <td><span id="deltaHco3">--</span></td>
        <td>mmol/L (24 − HCO₃⁻)</td>
      </tr>
      <tr>
        <td>Delta–delta ratio</td>
        <td><span id="deltaDeltaRatio">--</span></td>
        <td>(ΔAG / ΔHCO₃⁻)</td>
      </tr>
      <tr>
        <td>Strong ion difference (simplified)</td>
        <td><span id="sid">--</span></td>
        <td>mmol/L ((Na⁺ + K⁺) − Cl⁻ − lactate)</td>
      </tr>
      <tr>
        <td>Base excess (approx.)</td>
        <td><span id="baseExcess">--</span></td>
        <td>mmol/L (0.9287 × [HCO₃⁻ − 24.4 + 14.83 × (pH − 7.40)])</td>
      </tr>
      <tr>
        <td>Expected pCO₂ (compensation)</td>
        <td><span id="expectedPco2">--</span></td>
        <td>mmHg (Winter’s / metabolic alkalosis rule)</td>
      </tr>
    </table>
    <div class="interpretation" id="pco2Interpretation"></div>

    <div class="note">
      Assumptions: normal AG = 12 mmol/L, normal HCO₃⁻ = 24 mmol/L, albumin 40 g/L, SI units, simplified SID.
      Base excess uses the Siggaard-Andersen approximation and assumes normal Hb.
      Use clinical judgment and local guidelines.
    </div>
  </div>
</div>

<script>
  // Helper: safely parse numeric input (returns null if empty/NaN)
  function getVal(id) {
    const v = parseFloat(document.getElementById(id).value);
    return isNaN(v) ? null : v;
  }

  function formatNumber(x, digits = 1) {
    if (x === null || x === undefined || isNaN(x)) return "--";
    return x.toFixed(digits);
  }

  function calculateAll() {
    const na = getVal("na");
    const k = getVal("k");
    const cl = getVal("cl");
    const hco3 = getVal("hco3");
    const albumin = getVal("albumin"); // g/L
    const glucose = getVal("glucose"); // mmol/L
    const urea = getVal("urea");       // mmol/L
    const osmMeasured = getVal("osmMeasured");
    const lactate = getVal("lactate");
    const pco2 = getVal("pco2");       // mmHg
    const ph = getVal("ph");           // arterial pH

    let ag = null;
    let agCorr = null;
    let naCorr = null;
    let calcOsm = null;
    let osmGap = null;
    let deltaAg = null;
    let deltaHco3 = null;
    let deltaDeltaRatio = null;
    let sid = null;
    let baseExcess = null;
    let expectedPco2 = null;
    let expectedLow = null;
    let expectedHigh = null;
    let pco2Interp = "";

    // Anion gap: Na - (Cl + HCO3)
    if (na !== null && cl !== null && hco3 !== null) {
      ag = na - (cl + hco3);
    }

    // Corrected AG for albumin (albumin in g/L)
    if (ag !== null && albumin !== null) {
      // AGcorr = AG + 2.5(4 - albumin[g/dL]) -> 0.25 when albumin in g/L
      agCorr = ag + 0.25 * (40 - albumin);
    }

    // Corrected Na for glucose (SI version of 1.6 mEq per 100 mg/dL)
    if (na !== null && glucose !== null) {
      // 100 mg/dL ~ 5.6 mmol/L; slope ≈ 1.6 / 5.6 ≈ 0.288
      const threshold = 5.6;
      if (glucose > threshold) {
        naCorr = na + 0.288 * (glucose - threshold);
      } else {
        naCorr = na;
      }
    }

    // Calculated osmolality and osmolar gap: 2*Na + glucose + urea
    if (na !== null && glucose !== null && urea !== null) {
      calcOsm = 2 * na + glucose + urea;
      if (osmMeasured !== null) {
        osmGap = osmMeasured - calcOsm;
      }
    }

    // Delta–delta: using normal AG = 12, normal HCO3 = 24
    const normalAG = 12;
    const normalHco3 = 24;
    if (ag !== null && hco3 !== null) {
      deltaAg = ag - normalAG;
      deltaHco3 = normalHco3 - hco3;
      if (deltaHco3 !== 0) {
        deltaDeltaRatio = deltaAg / deltaHco3;
      }
    }

    // Strong ion difference (simplified): (Na + K) - Cl - lactate
    if (na !== null && cl !== null) {
      const kVal = k !== null ? k : 0;
      const lact = lactate !== null ? lactate : 0;
      sid = (na + kVal) - cl - lact;
    }

    // Base excess (approximate Siggaard-Andersen formula)
    // BE = 0.9287 × [HCO3− − 24.4 + 14.83 × (pH − 7.40)]
    if (hco3 !== null && ph !== null) {
      baseExcess = 0.9287 * (hco3 - 24.4 + 14.83 * (ph - 7.40));
    }

    // CO2 compensation: Winters formula or metabolic alkalosis rule
    if (hco3 !== null) {
      if (hco3 < 22) {
        // Metabolic acidosis: Winters
        expectedPco2 = 1.5 * hco3 + 8;
        expectedLow = expectedPco2 - 2;
        expectedHigh = expectedPco2 + 2;
        pco2Interp = "Pattern: metabolic acidosis (Winter's formula).";
      } else if (hco3 > 26) {
        // Metabolic alkalosis
        expectedPco2 = 0.7 * hco3 + 20;
        expectedLow = expectedPco2 - 5;
        expectedHigh = expectedPco2 + 5;
        pco2Interp = "Pattern: metabolic alkalosis (expected respiratory compensation).";
      } else {
        // Near-normal bicarbonate
        expectedPco2 = null;
        expectedLow = null;
        expectedHigh = null;
        pco2Interp = "HCO₃⁻ near normal; standard metabolic compensation formulas may not apply.";
      }
    }

    // Compare measured pCO2 to expected range if both available
    if (pco2 !== null && expectedPco2 !== null) {
      if (pco2 >= expectedLow && pco2 <= expectedHigh) {
        pco2Interp += " Measured pCO₂ is within the expected compensatory range.";
      } else if (pco2 < expectedLow) {
        pco2Interp += " Measured pCO₂ is lower than expected (additional respiratory alkalosis).";
      } else if (pco2 > expectedHigh) {
        pco2Interp += " Measured pCO₂ is higher than expected (additional respiratory acidosis).";
      }
    } else if (pco2 === null && expectedPco2 !== null) {
      pco2Interp += " Enter measured pCO₂ to assess adequacy of compensation.";
    }

    // Update DOM
    document.getElementById("anionGap").textContent        = formatNumber(ag);
    document.getElementById("corrAnionGap").textContent    = formatNumber(agCorr);
    document.getElementById("corrNa").textContent          = formatNumber(naCorr);
    document.getElementById("calcOsm").textContent         = formatNumber(calcOsm, 0);
    document.getElementById("osmGap").textContent          = formatNumber(osmGap, 0);
    document.getElementById("deltaAg").textContent         = formatNumber(deltaAg);
    document.getElementById("deltaHco3").textContent       = formatNumber(deltaHco3);
    document.getElementById("deltaDeltaRatio").textContent = formatNumber(deltaDeltaRatio, 2);
    document.getElementById("sid").textContent             = formatNumber(sid);
    document.getElementById("baseExcess").textContent      = formatNumber(baseExcess, 1);

    if (expectedPco2 !== null) {
      const text = formatNumber(expectedPco2, 1) +
        " mmHg (range " + formatNumber(expectedLow, 1) +
        " – " + formatNumber(expectedHigh, 1) + ")";
      document.getElementById("expectedPco2").textContent = text;
    } else {
      document.getElementById("expectedPco2").textContent = "--";
    }

    document.getElementById("pco2Interpretation").textContent = pco2Interp;
  }
</script>
</body>
</html>
